<html lang="es">

<head>
  <title>Visor 1 icgc</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="autor" />
  <meta name="description" content="descripción página">
  <meta name="robots" content="index,follow">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" /> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />

  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- Treballar en CANVAS millora el rendiment. És un métode per rasteritzar les geometries -->
  <script>
    L_PREFER_CANVAS = true; 
  </script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script> -->
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script src="http://rawgithub.com/kartena/Proj4Leaflet/master/lib/proj4-compressed.js" type="text/javascript"></script>
  <script src="https://rawgithub.com/kartena/Proj4Leaflet/master/src/proj4leaflet.js" type="text/javascript"></script>
  <script src="https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js"></script>

  <!-- enllacem css i js del pluguin leaflet search ??-->
  <script src="js/leaflet-search.min.js"></script>
  <link rel="stylesheet" href="css/leaflet-search.min.css" />

<!-- enllacem css i js del pluguin leaflet-draw ??-->
  <script src="src-draw/Leaflet.draw.js"></script>
  <script src="src-draw/Leaflet.Draw.Event.js"></script>
  <link rel="stylesheet" href="src-draw/leaflet.draw.css"/>

  <script src="src-draw/Toolbar.js"></script>
  <script src="src-draw/Tooltip.js"></script>

  <script src="src-draw/ext/GeometryUtil.js"></script>
  <script src="src-draw/ext/LatLngUtil.js"></script>
  <script src="src-draw/ext/LineUtil.Intersect.js"></script>
  <script src="src-draw/ext/Polygon.Intersect.js"></script>
  <script src="src-draw/ext/Polyline.Intersect.js"></script>
  <script src="src-draw/ext/TouchEvents.js"></script>

  <script src="src-draw/draw/DrawToolbar.js"></script>
  <script src="src-draw/draw/handler/Draw.Feature.js"></script>
  <script src="src-draw/draw/handler/Draw.SimpleShape.js"></script>
  <script src="src-draw/draw/handler/Draw.Polyline.js"></script>
  <script src="src-draw/draw/handler/Draw.Marker.js"></script>
  <script src="src-draw/draw/handler/Draw.Circle.js"></script>
  <script src="src-draw/draw/handler/Draw.CircleMarker.js"></script>
  <script src="src-draw/draw/handler/Draw.Polygon.js"></script>
  <script src="src-draw/draw/handler/Draw.Rectangle.js"></script>

  <script src="src-draw/edit/EditToolbar.js"></script>
  <script src="src-draw/edit/handler/EditToolbar.Edit.js"></script>
  <script src="src-draw/edit/handler/EditToolbar.Delete.js"></script>

  <script src="src-draw/Control.Draw.js"></script>

  <script src="src-draw/edit/handler/Edit.Poly.js"></script>
  <script src="src-draw/edit/handler/Edit.SimpleShape.js"></script>
  <script src="src-draw/edit/handler/Edit.Rectangle.js"></script>
  <script src="src-draw/edit/handler/Edit.Marker.js"></script>
  <script src="src-draw/edit/handler/Edit.CircleMarker.js"></script>
  <script src="src-draw/edit/handler/Edit.Circle.js"></script>

<!-- enllacem js del pluguin leaflet-buffer ??-->
  <script src="js/leaflet.buffer.min.js"></script>

  <!-- <script src="js/leaflet.filelayer.js"></script>
  <script src="https://raw.githubusercontent.com/mapbox/togeojson/master/togeojson.js"></script> -->

  <style>
    ul,ol{list-style:none}
    h1,h2,h3,h4,h5,h6,pre,code{font-size:1em;}
    ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,body,html,p,blockquote,fieldset{
    margin:0;padding:0;line-height:1; list-style:none;}
    a img,:link img,:visited img, fieldset{border:none;}
    input[type=submit], input[type=reset], input[type=button] { *filter:chroma(color=#000000); }
        
    hr { clear:both; height:0; line-height:0; margin:0; padding:0; border:0; filter:alpha(opacity=0); }
        
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .header {
      position: relative;
      background-color: #B40404; 
      opacity: 0.7;
      height: 15%;
      min-height: 100px;
    }
    .logo-image { 
      position: absolute; 
      height:65px; 
      margin-top: 20px;
      margin-left: 15px}

    #map {
      height: 85%;
      width: 100%;
    }
  </style>

  <script>
    var map, orto56_57, orto94, orto08, OrtoCache, TopoCache, Cadastre, BaseMuni, NomMuni;
    var Tronc_AP7_VilaS, Tronc_AP7_Vilablareix, Remod_Enllaç, GI9903;
    var controlCapas;
    var controlEscala;
    var crs25831 = new L.Proj.CRS('EPSG:25831', '+proj=utm +zone=31 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
        {
          resolutions: [1100, 550, 275, 100, 50, 25, 10, 5, 2, 1, 0.5, 0.25]
        }
      );

      $(document).ready(function () {

      map = L.map('map', {
        center: [41.4624985,1.867519],
        zoom: 3,
        crs: crs25831,
        continuousWorld: true,
        worldCopyJump: false,
      });

 /*Cridem mapes base*/
        OrtoCache = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_mapesbase/wms/service?", {
          layers: 'orto25c',
          format: 'image/jpeg',
          crs: crs25831,
          continuousWorld: true,
          attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
        }).addTo(map);


        orto56_57 = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_ortohistorica/wms/service?", {
          layers: 'ovab5m',
          format: 'image/jpeg',
          crs: crs25831,
          continuousWorld: true,
          attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
        });

        orto94 = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_ortohistorica/wms/service?", {
          layers: 'orto5m1994',
          format: 'image/jpeg',
          crs: crs25831,
          continuousWorld: true,
          attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
        });

        orto08 = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_ortohistorica/wms/service?", {
          layers: 'orto25c2009',
          format: 'image/jpeg',
          crs: crs25831,
          continuousWorld: true,
          attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
        });

        TopoCache = L.tileLayer.wms("http://mapcache.icc.cat/map/bases/service?", {
          layers: 'topo',
          format: 'image/jpeg',
          crs: crs25831,
          continuousWorld: true,
        });

        BaseMuni = L.tileLayer.wms("http://geoserveis.icc.cat/icgc_bm5m/wms/service?", {
          layers: '10_MUNICIPI_PC',
          format: 'image/png',
          crs: crs25831,
          transparent: true,
          continuousWorld: true,
        });

        NomMuni = L.tileLayer.wms("http://geoserveis.icc.cat/icgc_bm5m/wms/service?", {
          layers: '60_NOMMUNICIPI_TX',
          format: 'image/png',
          crs: crs25831,
          transparent: true,
          continuousWorld: true,
        });

        Cadastre = L.tileLayer.wms("http://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?", {
          layers: "Catastro",//nombre de la capa (ver get capabilities)
          format: 'image/jpeg',
          // transparent: true,
          continuousWorld: true,
          version: '1.1.1',//wms version (ver get capabilities)
          attribution: "DIRECCION GENERAL DEL CATASTRO"
        });

  /*Inici GeoJson AJAX (crida a les geometries del fitxer)*/
      Tronc_AP7_VilaS = new L.GeoJSON.AJAX('datos/Tronc_AP7_Vila-Seca.geojson', {
        // maxZoom: 19,
        // minZoom: 5,
        fillColor: "#FFFF00",
        color: "#FF0000",
        weight: 1.5,
        opacity: 1,
        fillOpacity: 0.6,

        onEachFeature: function (feature, layer) {
          popupContent = "<b>" + "Proyecto:"+ feature.properties.PROYECTO + "</b><br>" + "Expediente: "+ feature.properties.EXPEDIENTE_EXP + "</b><br>" + "Codigo finca: " + feature.properties.CODI_FINCA + "</b><br>" + "Superfície: " + feature.properties.SUP_EXP_m2 +"m2"+ "</b><br> " + "Indemnización económica: " + feature.properties.MA + "</b><br>" + "Titular: " + feature.properties.TITULAR+"</b>";
          layer.bindPopup(popupContent);
        },
      });

       Tronc_AP7_Vilablareix = new L.GeoJSON.AJAX('datos/Tronc_AP7_Vilablareix.geojson', {
        // maxZoom: 19,
        // minZoom: 5,
        fillColor: "#FFFF00",
        color: "#FF0000",
        weight: 1.5,
        opacity: 1,
        fillOpacity: 0.6,

        onEachFeature: function (feature, layer) {
          popupContent = "<b>" + "Proyecto: "+ feature.properties.PROYECTO + "</b><br>" + "Expediente: " +feature.properties.EXPEDIENTE_EXP + "</b><br>" + "Codigo finca: " + feature.properties.CODI_FINCA + "</b><br>" + "Superfície: " + feature.properties.SUP_EXP_m2 +"m2"+ "</b><br> " + "Indemnización económica: " + feature.properties.MA + "</b><br>" + "Titular: " + feature.properties.TITULAR+"</b>";
          layer.bindPopup(popupContent);
        },
      });

       Remod_EnllaçVS = new L.GeoJSON.AJAX('datos/98-T-9913.geojson', {
        // maxZoom: 19,
        // minZoom: 5,
        fillColor: "#FFFF00",
        color: "#FF0000",
        weight: 1.5,
        opacity: 1,
        fillOpacity: 0.6,

        onEachFeature: function (feature, layer) {
          popupContent = "<b>" + "Proyecto: "+ feature.properties.PROYECTO + "</b><br>" + "Expediente: " + feature.properties.EXPEDIENTE_EXP + "</b><br>" + "Codigo finca: " + feature.properties.CODI_FINCA + "</b><br>" + "Superfície: " + feature.properties.SUP_EXP_m2 +"m2"+ "</b><br> " + "Indemnización económica: " + feature.properties.PREU_JUST + "</b><br>" + "Titular: " + feature.properties.TITULAR+"</b>";
          layer.bindPopup(popupContent);
        },
      });

       GI9903 = new L.GeoJSON.AJAX('datos/98-GI-9903.geojson', {
        // maxZoom: 19,
        // minZoom: 5,
        fillColor: "#FFFF00",
        color: "#FF0000",
        weight: 1.5,
        opacity: 1,
        fillOpacity: 0.6,

        onEachFeature: function (feature, layer) {
          popupContent = "<b>"+"Proyecto: "+ feature.properties.PROYECTO + "</b><br>" + "Expediente: " + feature.properties.EXPEDIENTE_EXP + "</b><br>" + "Codigo finca: " + feature.properties.CODI_FINCA + "</b><br>" + "Superfície: " + feature.properties.SUP_EXP_m2 +"m2"+ "</b><br> " + "Indemnización económica 1: " + feature.properties.PREU_JUST1 + "</b><br> " + "Indemnización económica 2: " + feature.properties.PREU_JUST2 + "</b><br>" + "Titular: " + feature.properties.TITULAR+"</b>";
          layer.bindPopup(popupContent);
        },
      });

      var TermeMunis = L.layerGroup ([BaseMuni, NomMuni]);
      var GrupCapes = L.layerGroup ([Tronc_AP7_VilaS, Tronc_AP7_Vilablareix, Remod_EnllaçVS, GI9903]).addTo(map);
        
   // Inici Plugin draw

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        // Set the title to show on the polygon button
        // L.drawLocal.draw.toolbar.buttons.polygon = 'Dibuixa un polígon';
        // L.drawLocal.draw.toolbar.buttons.polyline = 'Dibuixa un línea';

        var drawControl = new L.Control.Draw({
          position: 'topleft',
          draw: {
            polyline: true,
            polygon: true,
            circle: false,
            marker: true,
            circlemarker: false
          },
          edit: {
            featureGroup: drawnItems,
            remove: true,
            buffer: {
              replacePolylines: false,
              separateBuffer: false,
            },
          }
        });
        map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, function (e) {
          var type = e.layerType,
            layer = e.layer;
          // if (type === 'polygon') {
          //   layer.bindPopup('A popup!');
          // }
          drawnItems.addLayer(layer);
        });
        map.on(L.Draw.Event.EDITED, function (e) {
          var layers = e.layers;
          var countOfEditedLayers = 0;
          layers.eachLayer(function (layer) {
            countOfEditedLayers++;
          });
          console.log("Edited " + countOfEditedLayers + " layers");
        });


  /* definim mapes base*/
      var baseMaps = {
        "Ortofoto vigent": OrtoCache,
        "Ortofoto 2008":  orto08,
        "Ortofoto 1994":  orto94,
        "Vol Americà 56-57": orto56_57,
        "Topogràfic-icgc": TopoCache,
        "Cadastre": Cadastre,
      };
  /*definim capes*/
      var overlayMaps = {
        "Tronc AP-7 Vila-Seca": Tronc_AP7_VilaS,
        "Tronv AP-7 Vilablareix": Tronc_AP7_Vilablareix,
        "Projecte 98-T-9913": Remod_EnllaçVS,
        "Projecte 98-GI-9903": GI9903,
        "Termes Municipals": TermeMunis,
      };
     
  /* definim controls de capes i mapes*/
      controlCapas = L.control.layers(baseMaps, overlayMaps);
      controlCapas.addTo(map);
      controlEscala = L.control.scale();
      controlEscala.addTo(map);

  /*cridem el plugin de search map*/
      var searchControl = new L.Control.Search({
        layer: GrupCapes,
        propertyName: 'CODI_FINCA',
        marker: false,
        zoom: 11
      });

      searchControl.on('search:locationfound', function (e) {

        e.layer.setStyle({ fillColor: '#00FF00', color: '#FF0000' });
        if (e.layer._popup)
          e.layer.openPopup();

      }).on('search:collapsed', function (e) {

        Tronc_AP7_VilaS.eachLayer(function (layer) {	//restore feature color
          Tronc_AP7_VilaS.resetStyle(layer);
        });
        Remod_Enllaç.eachLayer(function (layer) {	//restore feature color
          Remod_Enllaç.resetStyle(layer);
        });
      });


      map.addControl(searchControl);

      var searchControl_2 = new L.Control.Search({
        layer: GrupCapes,
        propertyName: 'TITULAR',
        marker: false,
        zoom: 11
      });

      searchControl_2.on('search:locationfound', function (e) {

        // map.setZoom(16);
        e.layer.setStyle({ fillColor: '#00FF00', color: '#FF0000' });
        if (e.layer._popup)
          e.layer.openPopup();    

      }).on('search:collapsed', function (e) {

        Tronc_AP7_VilaS.eachLayer(function (layer) {	//restore feature color
          Tronc_AP7_VilaS.resetStyle(layer);
        });
        Remod_Enllaç.eachLayer(function (layer) {	//restore feature color
          Remod_Enllaç.resetStyle(layer);
        });
      });

      map.addControl(searchControl_2);

    });

    // L.Control.fileLayerLoad({
    //       // Allows you to use a customized version of L.geoJson.
    //       // For example if you are using the Proj4Leaflet leaflet plugin,
    //       // you can pass L.Proj.geoJson and load the files into the
    //       // L.Proj.GeoJson instead of the L.geoJson.
    //       layer: L.geoJson,
    //       // See http://leafletjs.com/reference.html#geojson-options
    //       layerOptions: { style: { color: 'red', opacity: 0.7 } },
    //       // Add to map after loading (default: true) ?
    //       addToMap: true,
    //       // File size limit in kb (default: 1024) ?
    //       fileSizeLimit: 1024,
    //       // Restrict accepted file formats (default: .geojson, .json, .kml, and .gpx) ?
    //       formats: [
    //         '.geojson',
    //         '.kml'
    //       ]
    //     }).addTo(map);

    //     var control = L.Control.fileLayerLoad();
    //     control.loader.on('data:loaded', function (event) {
    //       // event.layer gives you access to the layers you just uploaded!

    //       // Add to map layer switcher
    //       layerswitcher.addOverlay(event.layer, event.filename);
    //     });
    //     var control = L.Control.fileLayerLoad();
    //     control.loader.on('data:error', function (error) {
    //       // Do something usefull with the error!
    //       console, error(error);
    //     });

  </script>
</head>

<body>
  <div class="header">
    <p>
        <img class="logo-image" src="images/logo-visor.png">
    </p>
  </div>
  <div id="map"></div>
</body>

</html>